<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8" />
 <title>Mail::DMARC::HTTP</title>
 <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css" />
 <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
 <script type="text/javascript" src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>

<style type="text/css">
html, body {
  margin: 0;
  padding: 0;
  font-size: 80%;
  font-family: sans-serif;
}
td.dt-control {
  cursor: pointer;
}
td.dt-control::before {
  content: '▶';
  color: #888;
}
tr.shown td.dt-control::before {
  content: '▼';
}
.dmarc-pass, .dmarc-none       { background-color: #CCFFCC; }
.dmarc-fail, .dmarc-reject     { background-color: #FFCCCC; }
.dmarc-quarantine              { background-color: #FFFFCC; }
span.dmarc-cell {
  display: block;
  padding: 2px 4px;
}
table.child-detail {
  width: 100%;
  border-collapse: collapse;
  margin: 4px 0;
}
table.child-detail th, table.child-detail td {
  border: 1px solid #ccc;
  padding: 4px 6px;
}
.child-loading { padding: 4px; }
</style>

<script type="text/javascript">
function dmarcCell(value) {
  if (!value) return '';
  var cls = 'dmarc-' + value.toLowerCase();
  return '<span class="dmarc-cell ' + cls + '">' + value + '</span>';
}

function formatChildRows(rows) {
  if (!rows || !rows.length) return '<p>No detail rows found.</p>';
  var html = '<table class="child-detail"><thead><tr>'
    + '<th>Header From</th><th>IP</th><th>#</th><th>Disposition</th>'
    + '<th>SPF</th><th>DKIM</th><th>Envelope To</th><th>Envelope From</th>'
    + '</tr></thead><tbody>';
  rows.forEach(function(r) {
    html += '<tr>'
      + '<td>' + (r.header_from  || '') + '</td>'
      + '<td>' + (r.source_ip    || '') + '</td>'
      + '<td>' + (r.count        || '') + '</td>'
      + '<td>' + dmarcCell(r.disposition)  + '</td>'
      + '<td>' + dmarcCell(r.spf)          + '</td>'
      + '<td>' + dmarcCell(r.dkim)         + '</td>'
      + '<td>' + (r.envelope_to  || '') + '</td>'
      + '<td>' + (r.envelope_from || '') + '</td>'
      + '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

jQuery(document).ready(function() {
  // SQL column names as known by get_report() backend (null = not sortable)
  var colNames = ['r.id', 'fd.domain', 'a.org_name', 'r.begin', 'r.end', null];

  var table = jQuery('#grid').DataTable({
    processing: true,
    serverSide: true,
    ajax: function(data, callback) {
      var params = {
        rows: data.length,
        page: Math.floor(data.start / data.length) + 1,
      };
      if (data.order && data.order.length) {
        params.sidx = colNames[data.order[0].column - 1] || 'r.id';
        params.sord = data.order[0].dir === 'desc' ? 'desc' : 'asc';
      }
      if (data.search && data.search.value) {
        params.searchField  = 'fd.domain';
        params.searchString = data.search.value;
      }
      jQuery.ajax({
        url:  '/dmarc/json/report',
        type: 'POST',
        data: params,
        success: function(json) {
          callback({
            draw:            data.draw,
            recordsTotal:    json.total_rows,
            recordsFiltered: json.total_rows,
            data:            json.rows || [],
          });
        },
      });
    },
    columns: [
      { data: null,          title: '',            className: 'dt-control', orderable: false, defaultContent: '' },
      { data: 'rid',         title: 'Id' },
      { data: 'from_domain', title: 'Sender/From' },
      { data: 'author',      title: 'Org Name' },
      { data: 'begin',       title: 'Begin' },
      { data: 'end',         title: 'End' },
      { data: 'uuid',        title: 'UUID' },
    ],
    order: [[1, 'desc']],
    pageLength: 100,
    lengthMenu: [50, 100, 500],
  });

  jQuery('#grid tbody').on('click', 'td.dt-control', function() {
    var tr  = jQuery(this).closest('tr');
    var row = table.row(tr);
    if (row.child.isShown()) {
      row.child.hide();
      tr.removeClass('shown');
      return;
    }
    var rid    = row.data().rid;
    var rowIdx = row.index();
    // Show a loading placeholder immediately for instant visual feedback
    row.child('<p class="child-loading">Loading\u2026</p>').show();
    tr.addClass('shown');
    jQuery.getJSON('/dmarc/json/row?rid=' + rid, function(json) {
      // Re-fetch a fresh row reference in case DataTables re-drew the table
      table.row(rowIdx).child(formatChildRows(json.rows)).show();
    });
  });
});
</script>

</head>

<body>
<p><a href="https://search.cpan.org/dist/Mail-DMARC/">Mail::DMARC::HTTP</a>.</p>

<table id="grid" class="display" style="width:100%"><caption>DMARC Reports</caption></table>

</body>
</html>
